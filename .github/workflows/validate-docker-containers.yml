name: Docker containers validation

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'Dockerfile*'
      - '.github/workflows/validate-docker-containers.yml'
  pull_request:
    paths:
      - 'Dockerfile*'
      - '.github/workflows/validate-docker-containers.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-dockerfiles:
    name: Validate Docker containers
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Run hadolint on Dockerfiles (informative)
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with:
          dockerfile: "Dockerfile.*"
          recursive: true
          failure-threshold: warning
      
      - name: Validate Dockerfile syntax (informative)
        continue-on-error: true
        run: |
          echo "Validating Dockerfile syntax and best practices..."
          echo "Note: This validation is informative only and will not fail the build"
          echo ""
          
          # Find all Dockerfiles
          DOCKERFILES=$(find . -maxdepth 1 -name "Dockerfile*" -type f)
          
          if [ -z "$DOCKERFILES" ]; then
            echo "No Dockerfiles found!"
            exit 0
          fi
          
          echo "Found Dockerfiles:"
          echo "$DOCKERFILES"
          echo ""
          
          ISSUES=0
          PASSED=0
          
          for dockerfile in $DOCKERFILES; do
            echo "=========================================="
            echo "Validating: $dockerfile"
            echo "=========================================="
            
            # Check basic syntax - file should have FROM instruction
            if grep -q "^FROM " "$dockerfile"; then
              echo "✓ Has FROM instruction"
            else
              echo "⚠ Missing FROM instruction"
              ISSUES=$((ISSUES + 1))
            fi
            
            # Check for best practices
            if grep -q "apt-get update" "$dockerfile" && grep -q "apt-get install" "$dockerfile"; then
              echo "✓ Uses apt-get for package management"
            fi
            
            if grep -q "rm -rf /var/lib/apt/lists/" "$dockerfile" || grep -q "apt-get clean" "$dockerfile"; then
              echo "✓ Cleans up apt cache"
            fi
            
            # Check for common issues
            if grep -q 'RUN.*&&.*\\$' "$dockerfile"; then
              echo "✓ Uses multi-line RUN commands properly"
            fi
            
            PASSED=$((PASSED + 1))
            echo ""
          done
          
          echo "=========================================="
          echo "Dockerfile Validation Summary (Informative)"
          echo "=========================================="
          echo "Files checked: $PASSED"
          echo "Issues found: $ISSUES"
          echo ""
          
          if [ $ISSUES -gt 0 ]; then
            echo "⚠ Found $ISSUES issue(s) in Dockerfiles (informative only)"
          else
            echo "✅ All Dockerfiles passed validation checks!"
          fi
      
      - name: Build Docker images
        run: |
          echo "Building Docker images to validate they can be built successfully..."
          echo ""
          
          FAILED=0
          BUILT=0
          
          # Build Dockerfile.ubuntu
          if [ -f "Dockerfile.ubuntu" ]; then
            echo "=========================================="
            echo "Building: Dockerfile.ubuntu"
            echo "=========================================="
            
            if docker build -f Dockerfile.ubuntu \
              --build-arg DISTRO=ubuntu:20.04 \
              --build-arg KAS_VERSION=4.7 \
              -t test-kas-ubuntu:latest .; then
              echo "✓ Successfully built Dockerfile.ubuntu"
              BUILT=$((BUILT + 1))
            else
              echo "✗ Failed to build Dockerfile.ubuntu"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          fi
          
          # Build Dockerfile.debian
          if [ -f "Dockerfile.debian" ]; then
            echo "=========================================="
            echo "Building: Dockerfile.debian"
            echo "=========================================="
            
            if docker build -f Dockerfile.debian \
              -t test-kas-debian:latest .; then
              echo "✓ Successfully built Dockerfile.debian"
              BUILT=$((BUILT + 1))
            else
              echo "✗ Failed to build Dockerfile.debian"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          fi
          
          # Cleanup - remove built images to free space
          docker rmi test-kas-ubuntu:latest 2>/dev/null || true
          docker rmi test-kas-debian:latest 2>/dev/null || true
          
          echo "=========================================="
          echo "Docker Build Summary"
          echo "=========================================="
          echo "Successfully built: $BUILT"
          echo "Failed to build: $FAILED"
          echo ""
          
          if [ $FAILED -gt 0 ]; then
            echo "❌ Docker image build validation failed!"
            exit 1
          else
            echo "✅ All Docker images built successfully!"
          fi
