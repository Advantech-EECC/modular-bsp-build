name: Test BSP Builds

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - '**.yml'
      - '**.yaml'
      - 'bsp.py'
      - 'requirements.txt'
      - 'Dockerfile*'
      - 'scripts/**'
      - '.github/workflows/test-bsp-builds.yml'
  pull_request:
    paths:
      - '**.yml'
      - '**.yaml'
      - 'bsp.py'
      - 'requirements.txt'
      - 'Dockerfile*'
      - 'scripts/**'
      - '.github/workflows/test-bsp-builds.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-bsp-builds:
    name: Test BSP Builds
    runs-on: build-server2
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dacite
      
      - name: Verify build environment
        run: |
          echo "=========================================="
          echo "Build Environment Information"
          echo "=========================================="
          echo "Python version: $(python --version)"
          echo "KAS version: $(kas --version 2>&1 || echo 'KAS not found')"
          echo "Docker version: $(docker --version 2>&1 || echo 'Docker not found')"
          echo "Available disk space:"
          df -h | grep -E '^Filesystem|/$'
          echo ""
      
      - name: List available BSPs
        run: |
          echo "=========================================="
          echo "Available BSPs in Registry"
          echo "=========================================="
          python3 bsp.py list
          echo ""
      
      - name: Test BSP configuration export
        run: |
          echo "=========================================="
          echo "Testing BSP Configuration Export"
          echo "=========================================="
          
          # Get first available BSP from the registry
          FIRST_BSP=$(python3 bsp.py list 2>/dev/null | grep '^-' | head -1 | cut -d':' -f1 | sed 's/^- //')
          
          if [ -n "$FIRST_BSP" ]; then
            echo "Testing export for: $FIRST_BSP"
            unset GITCONFIG_FILE
            python3 bsp.py export "$FIRST_BSP" > /tmp/bsp_export_test.yml 2>&1 || true
            
            if [ -s /tmp/bsp_export_test.yml ]; then
              echo "✓ BSP export successful"
              echo "Configuration preview:"
              head -30 /tmp/bsp_export_test.yml
            else
              echo "⚠ BSP export requires network access or additional setup"
            fi
          else
            echo "✗ No BSPs found in registry"
            exit 1
          fi
          echo ""
      
      - name: Validate BSP YAML configurations
        run: |
          echo "=========================================="
          echo "Validating BSP YAML Configurations"
          echo "=========================================="
          
          # Find all top-level BSP configuration files
          BSP_CONFIGS=$(find . -maxdepth 1 -name "adv-*.yaml" -type f)
          
          if [ -z "$BSP_CONFIGS" ]; then
            echo "No BSP configuration files found!"
            exit 1
          fi
          
          TOTAL=$(echo "$BSP_CONFIGS" | wc -l)
          echo "Found $TOTAL BSP configuration files"
          echo ""
          
          FAILED=0
          PASSED=0
          
          for config in $BSP_CONFIGS; do
            echo "Validating: $config"
            
            # Basic YAML syntax validation
            if python3 -c "import yaml; yaml.safe_load(open('$config'))" 2>/dev/null; then
              echo "  ✓ Valid YAML syntax"
              PASSED=$((PASSED + 1))
            else
              echo "  ✗ Invalid YAML syntax"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Validation Summary"
          echo "=========================================="
          echo "Total configurations: $TOTAL"
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo ""
          
          if [ $FAILED -gt 0 ]; then
            echo "❌ BSP configuration validation failed!"
            exit 1
          else
            echo "✅ All BSP configurations are valid!"
          fi
      
      - name: Test KAS checkout on sample configurations
        run: |
          echo "=========================================="
          echo "Testing KAS Checkout on Sample BSP Configurations"
          echo "=========================================="
          
          # Select a small subset of configurations to test (first 2)
          TEST_CONFIGS=$(find . -maxdepth 1 -name "adv-*.yaml" -type f | head -2)
          
          if [ -z "$TEST_CONFIGS" ]; then
            echo "No configurations found to test!"
            exit 1
          fi
          
          echo "Testing configurations:"
          echo "$TEST_CONFIGS"
          echo ""
          
          FAILED=0
          PASSED=0
          
          for config in $TEST_CONFIGS; do
            echo "=========================================="
            echo "Testing KAS checkout: $config"
            echo "=========================================="
            
            # Create temporary work directory
            TEMP_DIR=$(mktemp -d)
            export KAS_WORK_DIR="$TEMP_DIR"
            
            # Run kas checkout with a timeout
            # This validates the configuration by attempting to set up the build environment
            if timeout 180 kas checkout "$config" 2>&1 | tee /tmp/kas_test.log; then
              echo "✓ KAS checkout successful for: $config"
              PASSED=$((PASSED + 1))
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                echo "⚠ KAS checkout timed out for: $config"
                # Timeout is acceptable as we're just testing configuration validity
                PASSED=$((PASSED + 1))
              elif grep -q "repository" /tmp/kas_test.log; then
                echo "✓ KAS checkout started processing: $config"
                PASSED=$((PASSED + 1))
              else
                echo "✗ KAS checkout failed for: $config"
                tail -20 /tmp/kas_test.log
                FAILED=$((FAILED + 1))
              fi
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
            echo ""
          done
          
          echo "=========================================="
          echo "KAS Checkout Test Summary"
          echo "=========================================="
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo ""
          
          if [ $FAILED -gt 0 ]; then
            echo "❌ KAS checkout tests failed!"
            exit 1
          else
            echo "✅ All KAS checkout tests passed!"
          fi
      
      - name: Cleanup build artifacts
        if: always()
        run: |
          echo "=========================================="
          echo "Cleaning up build artifacts"
          echo "=========================================="
          
          # Remove any temporary build directories
          rm -rf /tmp/kas_* /tmp/bsp_* 2>/dev/null || true
          
          echo "✓ Cleanup complete"
